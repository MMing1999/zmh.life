name: Deploy Preview (dev â†’ web)

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° dev åˆ†æ”¯
on:
  push:
    branches:
      - dev
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äº gh-pages action
      
      # 2. è®¾ç½® Node.js 20
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci
      
      # 4. æ„å»ºé¡¹ç›®ï¼ˆæ³¨å…¥ç¯å¢ƒå˜é‡ï¼‰
      - name: Build Eleventy project
        run: npm run build
        env:
          # ä» GitHub Secrets è¯»å– Notion API é…ç½®
          # éœ€è¦åœ¨ GitHub â†’ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ ä»¥ä¸‹ Secretsï¼š
          # - NOTION_API_TOKEN: ä½ çš„ Notion API Token
          # - IDEAS_DATABASE_ID: æƒ³æ³•æ•°æ®åº“ ID
          # - QUESTIONS_DATABASE_ID: é—®é¢˜æ•°æ®åº“ ID
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          IDEAS_DATABASE_ID: ${{ secrets.IDEAS_DATABASE_ID }}
          QUESTIONS_DATABASE_ID: ${{ secrets.QUESTIONS_DATABASE_ID }}
      
      # 5. å‘å¸ƒåˆ° web åˆ†æ”¯ï¼ˆGitHub Pagesï¼‰
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          # å‘å¸ƒåˆ° web åˆ†æ”¯
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: web
          # å¼ºåˆ¶åˆ›å»ºå­¤ç«‹åˆ†æ”¯ï¼ˆæ¸…ç©ºå†å²ï¼‰
          force_orphan: true
          # æäº¤ä¿¡æ¯
          commit_message: 'chore: auto-deploy from dev â†’ web'
      
      # 6. è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
      - name: Output deployment info
        run: |
          echo "ğŸš€ GitHub Pages éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“ æ„å»ºäº§ç‰©å·²å‘å¸ƒåˆ° web åˆ†æ”¯"
          echo "ğŸŒ é¢„è§ˆç«™ç‚¹: https://mming1999.github.io/zmh.life/"
          echo "ğŸ“ æäº¤å“ˆå¸Œ: ${{ github.sha }}"
          echo "ğŸ”— Actions URL: https://github.com/MMing1999/zmh.life/actions"
