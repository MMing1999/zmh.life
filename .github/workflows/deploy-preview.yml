name: Deploy Preview (dev â†’ web)

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° dev åˆ†æ”¯
on:
  push:
    branches:
      - dev
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äº gh-pages action
      
      # 2. è®¾ç½® Node.js 20
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci
      
      # 4. æ„å»ºé¡¹ç›®ï¼ˆæ³¨å…¥ç¯å¢ƒå˜é‡ï¼‰
      - name: Build Eleventy project
        run: npm run build
        env:
          # ä» GitHub Secrets è¯»å– Notion API é…ç½®
          # éœ€è¦åœ¨ GitHub â†’ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ ä»¥ä¸‹ Secretsï¼š
          # - NOTION_API_TOKEN: ä½ çš„ Notion API Token
          # - IDEAS_DATABASE_ID: æƒ³æ³•æ•°æ®åº“ ID
          # - QUESTIONS_DATABASE_ID: é—®é¢˜æ•°æ®åº“ ID
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN || 'placeholder_token' }}
          IDEAS_DATABASE_ID: ${{ secrets.IDEAS_DATABASE_ID || 'placeholder_ideas_id' }}
          QUESTIONS_DATABASE_ID: ${{ secrets.QUESTIONS_DATABASE_ID || 'placeholder_questions_id' }}
      
      # 4.5. éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify build output
        run: |
          echo "ğŸ“ æ£€æŸ¥æ„å»ºäº§ç‰©..."
          ls -la dist/
          echo "ğŸ“„ æ£€æŸ¥ index.html..."
          head -10 dist/index.html
          echo "âœ… æ„å»ºéªŒè¯å®Œæˆ"
      
      # 5. æ‰‹åŠ¨æ¨é€åˆ° web åˆ†æ”¯
      - name: Deploy to web branch
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° web åˆ†æ”¯..."
          
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ è¿œç¨‹ä»“åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
          git remote -v
          
          # åˆ›å»ºæˆ–åˆ‡æ¢åˆ° web åˆ†æ”¯
          git checkout -B web
          
          # æ¸…ç©ºå½“å‰åˆ†æ”¯å†…å®¹
          git rm -rf . || true
          
          # å¤åˆ¶æ„å»ºäº§ç‰©
          cp -r dist/* . || true
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # æäº¤æ›´æ”¹
          git commit -m "chore: auto-deploy from dev â†’ web" || echo "No changes to commit"
          
          # æ¨é€åˆ°è¿œç¨‹ web åˆ†æ”¯
          git push origin web --force
          
          echo "âœ… éƒ¨ç½²åˆ° web åˆ†æ”¯å®Œæˆï¼"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 6. è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
      - name: Output deployment info
        run: |
          echo "ğŸš€ GitHub Pages éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“ æ„å»ºäº§ç‰©å·²å‘å¸ƒåˆ° web åˆ†æ”¯"
          echo "ğŸŒ é¢„è§ˆç«™ç‚¹: https://mming1999.github.io/zmh.life/"
          echo "ğŸ“ æäº¤å“ˆå¸Œ: ${{ github.sha }}"
          echo "ğŸ”— Actions URL: https://github.com/MMing1999/zmh.life/actions"
