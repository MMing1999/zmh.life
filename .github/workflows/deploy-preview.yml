name: Deploy Preview (dev → web)

# 触发条件：推送到 dev 分支
on:
  push:
    branches:
      - dev
  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录，用于 gh-pages action
      
      # 2. 设置 Node.js 20
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. 安装依赖
      - name: Install dependencies
        run: npm ci
      
      # 4. 构建项目（注入环境变量）
      - name: Build Eleventy project
        run: npm run build
        env:
          # 从 GitHub Secrets 读取 Notion API 配置
          # 需要在 GitHub → Settings → Secrets and variables → Actions 中添加以下 Secrets：
          # - NOTION_API_TOKEN: 你的 Notion API Token
          # - IDEAS_DATABASE_ID: 想法数据库 ID
          # - QUESTIONS_DATABASE_ID: 问题数据库 ID
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN || 'placeholder_token' }}
          IDEAS_DATABASE_ID: ${{ secrets.IDEAS_DATABASE_ID || 'placeholder_ideas_id' }}
          QUESTIONS_DATABASE_ID: ${{ secrets.QUESTIONS_DATABASE_ID || 'placeholder_questions_id' }}
      
      # 4.5. 验证构建产物
      - name: Verify build output
        run: |
          echo "📁 检查构建产物..."
          ls -la dist/
          echo "📄 检查 index.html..."
          head -10 dist/index.html
          echo "✅ 构建验证完成"
      
      # 5. 手动推送到 web 分支
      - name: Deploy to web branch
        run: |
          echo "🚀 开始部署到 web 分支..."
          
          # 配置 Git 用户信息
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 添加远程仓库（如果需要）
          git remote -v
          
          # 创建或切换到 web 分支
          git checkout -B web
          
          # 清空当前分支内容
          git rm -rf . || true
          
          # 复制构建产物
          cp -r dist/* . || true
          
          # 添加所有文件
          git add .
          
          # 提交更改
          git commit -m "chore: auto-deploy from dev → web" || echo "No changes to commit"
          
          # 推送到远程 web 分支
          git push origin web --force
          
          echo "✅ 部署到 web 分支完成！"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 6. 输出部署信息
      - name: Output deployment info
        run: |
          echo "🚀 GitHub Pages 部署完成！"
          echo "📁 构建产物已发布到 web 分支"
          echo "🌐 预览站点: https://mming1999.github.io/zmh.life/"
          echo "📝 提交哈希: ${{ github.sha }}"
          echo "🔗 Actions URL: https://github.com/MMing1999/zmh.life/actions"
